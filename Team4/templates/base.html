<!-- 
================================================================================
BASE TEMPLATE FOR CLUB HOUSE MANAGEMENT SYSTEM
================================================================================
This is the main layout template that all other pages extend.
It provides:
- Responsive Bootstrap-based navigation bar
- Role-based navigation menu items
- Flash message display system
- Consistent styling and layout structure
- JavaScript for interactive features

Navigation is dynamically generated based on user role:
- Member: Basic navigation (Home, Students, Clubs)
- Officer: Administrative navigation (includes Roster management)
- Public: Limited navigation for non-logged-in users
================================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}Club House System{% endblock %}</title>

  <!-- Bootstrap CSS for responsive design and components -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Bootstrap Icons for UI icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <!-- Custom CSS for application-specific styling -->
  <link href="{{ url_for('static', filename='styles.css') }}" rel="stylesheet" />
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">

  {% block extra_head %}{% endblock %}
</head>
<body>
  <!-- Navigation Bar - responsive and role-aware -->
  <nav class="navbar navbar-expand-lg navbar-light bg-light sticky-top shadow-sm">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold text-primary" href="{{ url_for('index') }}">ClubHouse</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'index' %}active{% endif %}" href="{{ url_for('index') }}">Clubs</a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'students' %}active{% endif %}" href="{{ url_for('students') }}">Students</a>
          </li>
          
          {% if current_role == 'Officer' %}
          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'manage_invites' %}active{% endif %}" href="{{ url_for('manage_invites') }}">
              <i class="bi bi-link-45deg"></i> Invites
            </a>
          </li>
          {% endif %}

          {% if current_user %}
            <!-- Notification Bell -->
            <li class="nav-item dropdown me-3">
              <a class="nav-link position-relative" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-bell fs-5"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
                  <span id="notificationCount">0</span>
                </span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationDropdown" style="width: 350px; max-height: 400px; overflow-y: auto;">
                <li><h6 class="dropdown-header">Recent Announcements</h6></li>
                <div id="notificationList">
                  <li><span class="dropdown-item-text text-muted">Loading notifications...</span></li>
                </div>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-center small" href="#" onclick="markAllNotificationsRead()">Mark all as read</a></li>
              </ul>
            </li>
            
            <li class="nav-item d-flex align-items-center ms-2">
              <span class="badge bg-{{ 'primary' if current_role=='Officer' else 'secondary' }}">{{ current_role }}</span>
            </li>
            <li class="nav-item d-flex align-items-center ms-2">
              <span class="text-muted small">{{ current_user.email }}</span>
            </li>
            <li class="nav-item ms-2">
              <form method="post" action="{{ url_for('do_logout') }}">
                <button class="btn btn-outline-secondary btn-sm">Logout</button>
              </form>
            </li>
          {% else %}
            <li class="nav-item ms-2">
              <a class="btn btn-outline-primary btn-sm" href="{{ url_for('login_page', next=request.full_path) }}">Login</a>
            </li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- Flash messages -->
  {% include 'partials/flash.html' %}

  <!-- Main content area -->
  <main class="container mt-4">
    {% block content %}{% endblock %}
  </main>

  <!-- Footer -->
  <footer class="text-center mt-5 mb-3 text-muted small">
    © 2025 ClubHouse Management | Built with ❤️ Flask + Bootstrap
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  {% if current_user %}
  <!-- ===== NOTIFICATION SYSTEM JAVASCRIPT ===== -->
  <!-- Handles the notification bell dropdown in the top-right corner -->
  <script>
    // Track which notifications user has read in this session (client-side cache)
    let readNotifications = new Set();

    /**
     * Load notifications from the server via API
     * Fetches recent announcements (last 7 days) and displays them
     */
    function loadNotifications() {
      fetch('/api/notifications')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayNotifications(data.notifications);
          } else {
            console.error('Failed to load notifications:', data.error);
          }
        })
        .catch(error => {
          console.error('Error loading notifications:', error);
          // Show friendly message on error instead of breaking the UI
          document.getElementById('notificationList').innerHTML = 
            '<li><span class="dropdown-item-text text-muted">No announcements available</span></li>';
        });
    }

    /**
     * Display notifications in the dropdown menu
     * Updates the badge count and renders notification items
     * 
     * @param {Array} notifications - Array of announcement objects from API
     */
    function displayNotifications(notifications) {
      const notificationList = document.getElementById('notificationList');
      const notificationBadge = document.getElementById('notificationBadge');
      const notificationCount = document.getElementById('notificationCount');
      
      // Handle empty state
      if (!notifications || notifications.length === 0) {
        notificationList.innerHTML = '<li><span class="dropdown-item-text text-muted">No recent announcements</span></li>';
        notificationBadge.style.display = 'none';
        return;
      }

      // Get current user's email to check read status
      const userEmail = '{{ current_user.email if current_user else "" }}';
      
      // Filter unread notifications (not in server's read_by array AND not in client cache)
      const unreadNotifications = notifications.filter(n => !n.read_by.includes(userEmail) && !readNotifications.has(n.id));
      
      // Update badge with unread count
      if (unreadNotifications.length > 0) {
        notificationCount.textContent = unreadNotifications.length;
        notificationBadge.style.display = 'block';
      } else {
        notificationBadge.style.display = 'none';
      }

      // Render notifications (max 10 most recent)
      let html = '';
      notifications.slice(0, 10).forEach(notification => {
        // Check if this notification is unread
        const isUnread = !notification.read_by.includes(userEmail) && !readNotifications.has(notification.id);
        
        // Apply color class based on priority level
        const priorityClass = notification.priority === 'high' ? 'text-danger' : 
                             notification.priority === 'medium' ? 'text-warning' : '';
        
        // Build HTML for each notification card
        html += `
          <li>
            <div class="dropdown-item px-3 py-2 ${isUnread ? 'bg-light border-start border-primary border-3' : ''}" 
                 onclick="markNotificationRead('${notification.id}')" style="cursor: pointer;">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <h6 class="mb-1 ${priorityClass}">
                    ${notification.title}
                    ${isUnread ? '<span class="badge bg-primary ms-1" style="font-size: 0.6em;">NEW</span>' : ''}
                  </h6>
                  <p class="mb-1 small text-muted">${notification.content.substring(0, 100)}${notification.content.length > 100 ? '...' : ''}</p>
                  <small class="text-muted">
                    <i class="bi bi-building"></i> ${notification.club_name} • ${notification.created_at_formatted || 'Recently'}
                  </small>
                </div>
              </div>
            </div>
          </li>
        `;
      });
      
      notificationList.innerHTML = html;
    }

    /**
     * Mark a single notification as read
     * Called when user clicks on a notification in the dropdown
     * 
     * @param {string} announcementId - The Firebase document ID of the announcement
     */
    function markNotificationRead(announcementId) {
      // Skip if already marked read in this session
      if (readNotifications.has(announcementId)) return;
      
      // Send POST request to mark as read in Firebase
      fetch('/api/notifications/mark-read', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ announcement_id: announcementId })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Add to client-side cache and refresh display
          readNotifications.add(announcementId);
          loadNotifications(); // Refresh to update badge count
        }
      })
      .catch(error => console.error('Error marking notification as read:', error));
    }

    /**
     * Mark all visible notifications as read
     * Useful for bulk marking when user wants to clear all notifications
     */
    function markAllNotificationsRead() {
      fetch('/api/notifications')
        .then(response => response.json())
        .then(data => {
          if (data.success && data.notifications) {
            const userEmail = '{{ current_user.email if current_user else "" }}';
            
            // Filter unread notifications and create mark-read requests
            const promises = data.notifications
              .filter(n => !n.read_by.includes(userEmail) && !readNotifications.has(n.id))
              .map(n => {
                readNotifications.add(n.id);  // Add to client cache
                return fetch('/api/notifications/mark-read', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ announcement_id: n.id })
                });
              });
            
            // Wait for all requests to complete, then refresh display
            Promise.all(promises).then(() => {
              loadNotifications();
            });
          }
        });
    }

    // ===== INITIALIZE NOTIFICATION SYSTEM =====
    // Load notifications when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadNotifications();
      // Auto-refresh notifications every 5 minutes (300,000 ms) to show new announcements
      setInterval(loadNotifications, 300000);
    });
  </script>
  {% endif %}

  {% block extra_scripts %}{% endblock %}
</body>
</html>
